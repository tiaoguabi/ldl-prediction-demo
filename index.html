<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LDL-C Prediction Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@latest/dist/ort.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    label, input, select {
      display: block;
      margin-bottom: 10px;
    }
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 8px;
    }
    table {
      margin-top: 20px;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>LDL-C Prediction Tool</h1>
  <form id="inputForm">
    <label for="tc">Total Cholesterol (TC):</label>
    <input type="number" id="tc" required />

    <label for="tg">Triglycerides (TG):</label>
    <input type="number" id="tg" required />

    <label for="hdl">HDL Cholesterol:</label>
    <input type="number" id="hdl" required />

    <label for="unit">Unit:</label>
    <select id="unit">
      <option value="mg">mg/dL</option>
      <option value="mmol">mmol/L</option>
    </select>

    <button type="submit">Predict LDL-C</button>
  </form>

  <h2>LDL-C Results</h2>
  <table>
    <thead>
      <tr>
        <th>Method</th>
        <th>LDL-C (mg/dL)</th>
        <th>LDL-C (mmol/L)</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>ONNX Model</td><td id="ldl_model_mg">-</td><td id="ldl_model_mmol">-</td></tr>
      <tr><td>Friedewald</td><td id="friedewald_mg">-</td><td id="friedewald_mmol">-</td></tr>
      <tr><td>Martin/Hopkins</td><td id="martin_mg">-</td><td id="martin_mmol">-</td></tr>
      <tr><td>Sampson</td><td id="sampson_mg">-</td><td id="sampson_mmol">-</td></tr>
    </tbody>
  </table>

  <p><strong>Note:</strong> Negative or invalid results indicate an unreliable calculation. Consider direct LDL-C measurement in such cases.</p>

  <script>
    // Conversion multipliers
    const CHOL_CONV = 38.67;
    const TG_CONV = 88.57;

    // Martin/Hopkins reference table
    const tgRanges = [0, 50, 57, 62, 67, 72, 76, 80, 84, 88, 93, 97, 101,
      106, 111, 116, 121, 127, 133, 139, 147, 155, 164, 174,
      186, 202, 221, 248, 293, 400, Infinity];

    const nonHDLbins = [0, 100, 130, 160, 190, 220, Infinity];

    const factorMatrix = [
      [3.5, 3.4, 3.3, 3.3, 3.2, 3.1],
      [4, 3.9, 3.7, 3.6, 3.6, 3.4],
      [4.3, 4.1, 4, 3.9, 3.8, 3.6],
      [4.5, 4.3, 4.1, 4, 3.9, 3.9],
      [4.7, 4.4, 4.3, 4.2, 4.1, 3.9],
      [4.8, 4.6, 4.4, 4.2, 4.2, 4.1],
      [4.9, 4.6, 4.5, 4.3, 4.3, 4.2],
      [5, 4.8, 4.6, 4.4, 4.3, 4.2],
      [5.1, 4.8, 4.6, 4.5, 4.4, 4.3],
      [5.2, 4.9, 4.7, 4.6, 4.4, 4.3],
      [5.3, 5, 4.8, 4.7, 4.5, 4.4],
      [5.4, 5.1, 4.8, 4.7, 4.5, 4.3],
      [5.5, 5.2, 5, 4.7, 4.6, 4.5],
      [5.6, 5.3, 5, 4.8, 4.6, 4.5],
      [5.7, 5.4, 5.1, 4.9, 4.7, 4.5],
      [5.8, 5.5, 5.2, 5, 4.8, 4.6],
      [6, 5.5, 5.3, 5, 4.8, 4.6],
      [6.1, 5.7, 5.3, 5.1, 4.9, 4.7],
      [6.2, 5.8, 5.4, 5.2, 5, 4.7],
      [6.3, 5.9, 5.6, 5.3, 5, 4.8],
      [6.5, 6, 5.7, 5.4, 5.1, 4.8],
      [6.7, 6.2, 5.8, 5.4, 5.2, 4.9],
      [6.8, 6.3, 5.9, 5.5, 5.3, 5],
      [7, 6.5, 6, 5.7, 5.4, 5.1],
      [7.3, 6.7, 6.2, 5.8, 5.5, 5.2],
      [7.6, 6.9, 6.4, 6, 5.6, 5.3],
      [8, 7.2, 6.6, 6.2, 5.9, 5.4],
      [8.5, 7.6, 7, 6.5, 6.1, 5.6],
      [9.5, 8.3, 7.5, 7, 6.5, 5.9],
      [11.9, 10, 8.8, 8.1, 7.5, 6.7]
    ];

    async function loadModel() {
      return await ort.InferenceSession.create(
        'https://raw.githubusercontent.com/tiaoguabi/ldl-prediction-demo/main/ebm_model.onnx'
      );
    }

    function toMg(value, unit, isTG = false) {
      if (unit === 'mmol') {
        return isTG ? value * TG_CONV : value * CHOL_CONV;
      }
      return value;
    }

    function toMmol(mg, isTG = false) {
      return (mg / (isTG ? TG_CONV : CHOL_CONV)).toFixed(2);
    }

    function setOutput(id, value) {
      const mg = value <= 0 || isNaN(value) ? 'Invalid' : value.toFixed(2);
      const mmol = value <= 0 || isNaN(value) ? 'Invalid' : toMmol(value);
      document.getElementById(id + '_mg').innerText = mg;
      document.getElementById(id + '_mmol').innerText = mmol;
    }

    function calculateFriedewald(tc, hdl, tg) {
      return tc - hdl - (tg / 5);
    }

    function calculateSampson(tc, hdl, tg) {
      const nonHDL = tc - hdl;
      return (tc / 0.948) - (hdl / 0.971) - ((tg / 8.56) + (tg * nonHDL / 2140) - (tg ** 2 / 16100)) - 9.44;
    }

    function calculateMartinHopkins(tc, hdl, tg) {
      const nonHDL = tc - hdl;
      const tgIdx = tgRanges.findIndex(r => tg < r) - 1;
      const nonHDLIdx = nonHDLbins.findIndex(r => nonHDL < r) - 1;
      if (tgIdx >= 0 && nonHDLIdx >= 0) {
        const factor = factorMatrix[tgIdx][nonHDLIdx];
        return nonHDL - (tg / factor);
      }
      return NaN;
    }

    async function predict(event) {
      event.preventDefault();

      const unit = document.getElementById('unit').value;
      const tc = toMg(parseFloat(document.getElementById('tc').value), unit);
      const tg = toMg(parseFloat(document.getElementById('tg').value), unit, true);
      const hdl = toMg(parseFloat(document.getElementById('hdl').value), unit);

      const session = await loadModel();
      const feeds = {
        [session.inputNames[0]]: new ort.Tensor('float64', new Float64Array([tc]), [1]),
        [session.inputNames[1]]: new ort.Tensor('float64', new Float64Array([hdl]), [1]),
        [session.inputNames[2]]: new ort.Tensor('float64', new Float64Array([tg]), [1])
      };

      const results = await session.run(feeds);
      const modelResult = results[session.outputNames[0]].data[0];

      const friedewald = calculateFriedewald(tc, hdl, tg);
      const sampson = calculateSampson(tc, hdl, tg);
      const martin = calculateMartinHopkins(tc, hdl, tg);

      setOutput('ldl_model', modelResult);
      setOutput('friedewald', friedewald);
      setOutput('sampson', sampson);
      setOutput('martin', martin);
    }

    document.getElementById('inputForm').addEventListener('submit', predict);
  </script>
</body>
</html>
