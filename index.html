<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LDL Prediction Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@latest/dist/ort.min.js"></script>
  <style>
    table { border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em 1em; }
    .error { color: red; margin-top: 1em; }
    .citation { margin-top: 2em; font-size: 0.9em; }
    fieldset { margin-top: 1em; }
  </style>
</head>
<body>
  <h1>LDL Prediction Model</h1>
  <form id="inputForm">
    <fieldset>
      <legend>Input Unit</legend>
      <label><input type="radio" name="unit" value="mgdl" checked> mg/dL</label>
      <label><input type="radio" name="unit" value="mmoll"> mmol/L</label>
    </fieldset>

    <label for="tc">Total Cholesterol (TC):</label>
    <input type="number" step="0.01" id="tc" required /><br /><br />

    <label for="tg">Triglycerides (TG):</label>
    <input type="number" step="0.01" id="tg" required /><br /><br />

    <label for="hdl">HDL Cholesterol:</label>
    <input type="number" step="0.01" id="hdl" required /><br /><br />

    <button type="submit">Predict LDL</button>
  </form>

  <h2>LDL-C Results (mg/dL)</h2>
  <table>
    <thead>
      <tr><th>Method</th><th>LDL-C</th></tr>
    </thead>
    <tbody>
      <tr><td>ML Prediction</td><td id="mlResult">-</td></tr>
      <tr><td>Friedewald Equation</td><td id="friedewald">-</td></tr>
      <tr><td>Martin/Hopkins Equation</td><td id="martin">-</td></tr>
      <tr><td>Sampson Equation</td><td id="sampson">-</td></tr>
    </tbody>
  </table>

  <div id="errorMsg" class="error"></div>

  <div class="citation">
    References:<br />
    Friedewald WT, et al. Clin Chem 1972;18:499-502.<br />
    Martin SS, et al. JAMA 2013;310:2061-68.<br />
    Sampson M, et al. JAMA Cardiol. 2020;5(5):540â€“548.
  </div>

  <script>
    // Specify path to WASM assets for ONNX Runtime Web
    ort.env.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/onnxruntime-web@latest/dist/';

    // Load the ONNX model from GitHub Raw URL
    async function loadModel() {
      return await ort.InferenceSession.create(
        'https://raw.githubusercontent.com/tiaoguabi/ldl-prediction-demo/main/ebm_model.onnx'
      );
    }

    // Convert values to mg/dL if input is mmol/L
    function convertToMgdl(tc, hdl, tg, unit) {
      if (unit === 'mmoll') {
        const tc_mg = tc * 38.67;
        const hdl_mg = hdl * 38.67;
        const tg_mg = tg * 88.57;
        return [tc_mg, hdl_mg, tg_mg];
      }
      return [tc, hdl, tg];
    }

    // Friedewald formula implementation
    function calculateFriedewald(tc, hdl, tg) {
      return tc - hdl - (tg / 5);
    }

    // Martin/Hopkins formula implementation with factor lookup
    function calculateMartin(tc, hdl, tg) {
      const nonHDL = tc - hdl;
      const tgRanges = [0,50,57,62,67,72,76,80,84,88,93,97,101,106,111,116,121,127,133,139,147,155,164,174,186,202,221,248,293,400,Infinity];
      const nonHDLBins = [0,100,130,160,190,220,Infinity];
      const factorValues = [
        [3.5,3.4,3.3,3.3,3.2,3.1],[4,3.9,3.7,3.6,3.6,3.4],[4.3,4.1,4,3.9,3.8,3.6],
        [4.5,4.3,4.1,4,3.9,3.9],[4.7,4.4,4.3,4.2,4.1,3.9],[4.8,4.6,4.4,4.2,4.2,4.1],
        [4.9,4.6,4.5,4.3,4.3,4.2],[5,4.8,4.6,4.4,4.3,4.2],[5.1,4.8,4.6,4.5,4.4,4.3],
        [5.2,4.9,4.7,4.6,4.4,4.3],[5.3,5,4.8,4.7,4.5,4.4],[5.4,5.1,4.8,4.7,4.5,4.3],
        [5.5,5.2,5,4.7,4.6,4.5],[5.6,5.3,5,4.8,4.6,4.5],[5.7,5.4,5.1,4.9,4.7,4.5],
        [5.8,5.5,5.2,5,4.8,4.6],[6,5.5,5.3,5,4.8,4.6],[6.1,5.7,5.3,5.1,4.9,4.7],
        [6.2,5.8,5.4,5.2,5,4.7],[6.3,5.9,5.6,5.3,5,4.8],[6.5,6,5.7,5.4,5.1,4.8],
        [6.7,6.2,5.8,5.4,5.2,4.9],[6.8,6.3,5.9,5.5,5.3,5],[7,6.5,6,5.7,5.4,5.1],
        [7.3,6.7,6.2,5.8,5.5,5.2],[7.6,6.9,6.4,6,5.6,5.3],[8,7.2,6.6,6.2,5.9,5.4],
        [8.5,7.6,7,6.5,6.1,5.6],[9.5,8.3,7.5,7,6.5,5.9],[11.9,10,8.8,8.1,7.5,6.7]
      ];
      // find tg range index
      let tgIdx = tgRanges.findIndex((v,i) => tg >= tgRanges[i] && tg < tgRanges[i+1]);
      // find nonHDL bin index
      let nonIdx = nonHDLBins.findIndex((v,i) => nonHDL >= nonHDLBins[i] && nonHDL < nonHDLBins[i+1]);
      if (tgIdx < 0 || nonIdx < 0) return NaN;
      let factor = factorValues[tgIdx][nonIdx];
      return nonHDL - (tg / factor);
    }

    // Sampson formula implementation
    function calculateSampson(tc, hdl, tg) {
      const nonHDL = tc - hdl;
      return (tc / 0.948) - (hdl / 0.971)
             - ((tg / 8.56) + (tg * nonHDL / 2140) - (Math.pow(tg, 2) / 16100))
             - 9.44;
    }

    // Main predict handler
    async function predict(event) {
      event.preventDefault();
      document.getElementById('errorMsg').innerText = '';
      // get raw inputs
      let tc = parseFloat(document.getElementById('tc').value);
      let tg = parseFloat(document.getElementById('tg').value);
      let hdl= parseFloat(document.getElementById('hdl').value);
      // check unit and convert
      const unit = document.querySelector('input[name="unit"]:checked').value;
      [tc, hdl, tg] = convertToMgdl(tc, hdl, tg, unit);
      // load and run ML model
      const session = await loadModel();
      const feeds = {
        [session.inputNames[0]]: new ort.Tensor('float64', new Float64Array([tc]), [1]),
        [session.inputNames[1]]: new ort.Tensor('float64', new Float64Array([hdl]), [1]),
        [session.inputNames[2]]: new ort.Tensor('float64', new Float64Array([tg]), [1])
      };
      const results = await session.run(feeds);
      const mlLDL = results[session.outputNames[0]].data[0];
      // calculate formula results
      const fried = calculateFriedewald(tc, hdl, tg);
      const mart = calculateMartin(tc, hdl, tg);
      const samp = calculateSampson(tc, hdl, tg);
      // format display
      function format(v) { if (isNaN(v) || v <= 0) return 'Invalid (Consider direct LDL-C)'; return v.toFixed(2); }
      document.getElementById('mlResult').innerText  = format(mlLDL);
      document.getElementById('friedewald').innerText = format(fried);
      document.getElementById('martin').innerText    = format(mart);
      document.getElementById('sampson').innerText   = format(samp);
      if ([mlLDL, fried, mart, samp].some(x => isNaN(x) || x <= 0)) {
        document.getElementById('errorMsg').innerText = 'Warning: One or more LDL-C estimates are invalid. Consider direct LDL-C measurement.';
      }
    }

    // attach handler
    document.getElementById('inputForm').addEventListener('submit', predict);
  </script>
</body>
</html>
